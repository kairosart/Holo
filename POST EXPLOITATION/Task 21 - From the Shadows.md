Now that we have gained a decent foothold onto the network and have a stable shell, we can worry about setting up persistence so that we don't lose our foothold and gain our foothold again if the machine is reset or our shell gets terminated. There are many methods for persistence outlined below are a few examples.  

- LD_PRELOAD
- Backdoored binaries
- PAM backdoor
- SSH keys
- Malicious services
- Cronjob
- Credential harvesting

In this room, we will be focusing on credential harvesting specifically from the shadow file and how to crack passwords offline to gain long-term account access.  

For more information about persistence techniques check out MITRE ATT&CK [TA0003](https://attack.mitre.org/tactics/TA0003/).  

---

To begin with our persistence adventures, we will be focusing on dumping the shadow file on a Linux server. The shadow file is located in `/etc/shadow` and contains encrypted passwords and related information, including usernames, password change date, expiration, etc. We can use this file to retrieve hashes as an attacker and then attempt to crack the hashes using an offline hash cracking tool like Hashcat or JohntheRipper.  

Since the shadow file is a standard in the Linux kernel to authenticate accounts, you can expect it on every *nix machine you encounter.  

To dump the shadow file is simple; once you have root privileges, you need to read the file, and the machine will output the information in the shadow file. Find an example command below.  

Command used: `cat /etc/shadow`

![[Task 21 - From the Shadows-20240924134929338.webp]]


---

# Your job

- Get the `passwd` and `shadow` files.
	On the root reverse shell run:
	`cat passwd`

- Copy the content and paste it on a file on the attacking machine.
- Do the same with the `shadow` file.
- Once you have both files, we can run the `unshadowed` command which formats the 2 files into a single file ready for `hashcat` or `john`.
	`unshadow passwd shadow >> unshadowed.txt`

## Cracking passwords with john

Now 